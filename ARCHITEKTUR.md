# Architecture

Architecture, project structure, and core concepts of the Splitwise SDK.

## 1. Goal

Provide a type-safe SDK for the [Splitwise API v3.0](https://dev.splitwise.com/).

The SDK follows a **generator-first architecture**: types are auto-generated from the OpenAPI spec. Hand-written repositories wrap the generated client and add caching, retry, and error mapping.

## 2. Project Structure

```
src/
├── generated/              # generated by @hey-api/openapi-ts (committed, never manually edited)
│   └── types.gen.ts
├── core/                   # core infrastructure
│   ├── http-client.ts      # HTTP client with auth, cache, retry
│   ├── auth.ts             # token resolution and Bearer header
│   ├── errors.ts           # typed error hierarchy
│   ├── interceptors.ts     # request lifecycle (auth, logging, error parsing, retry)
│   └── logger.ts           # structured logging with requestId
├── repositories/           # resource-based modules
│   ├── ...
│   └── index.ts
├── utils/
│   ├── cache.ts            # in-memory TTL cache + deduplication
│   └── retry.ts            # exponential backoff + jitter
└── index.ts                # public API surface
```

## 3. Components

### 3.1. Generated Client (`src/generated/`)

Generated from `openapi.json` via `@hey-api/openapi-ts`:

- **`types.gen.ts`** — all request/response types for the Splitwise API

These files are committed but **never manually edited**. Regenerate with `npm run typegen`.

### 3.2. Core Layer (`src/core/`)

#### `auth.ts`

- `TokenProvider` type: string or (async) function
- Runtime token resolution
- Bearer header formatting
- `AuthenticationError` on missing token

#### `errors.ts`

Typed error hierarchy:

```
Error
└── SplitwiseError (base)
    ├── SplitwiseApiError (status, endpoint, requestId, retryable)
    │   ├── AuthenticationError (401)
    │   ├── AuthorizationError (403)
    │   ├── NotFoundError (404)
    │   ├── ValidationError (400/422)
    │   ├── ConflictError (409)
    │   └── RateLimitError (429 + retryAfter)
    └── NetworkError (fetch/timeout, always retryable)
```

#### `interceptors.ts`

Request lifecycle:

1. Bearer token injection
2. `requestId` generation (UUID)
3. Request duration measurement
4. Structured logging (start/success/error)
5. Error parsing via `parseHttpError()`
6. Retry logic for retryable errors

#### `http-client.ts`

Central HTTP client wiring all core components:

- GET requests with cache + deduplication
- POST requests with cache invalidation
- Configurable via `HttpClientConfig`

#### `logger.ts`

- `Logger` interface with structured `LogEntry` objects
- `DefaultLogger`: JSON output to stdout/stderr with level filtering
- `SilentLogger`: no output
- `CallbackLogger`: delegates to user-defined function

### 3.3. Repositories (`src/repositories/`)

Each repository wraps an API resource and extends `BaseRepository`:

| Repository                | Resource      |
| ------------------------- | ------------- |
| `UsersRepository`         | Users         |
| `GroupsRepository`        | Groups        |
| `ExpensesRepository`      | Expenses      |
| `FriendsRepository`       | Friends       |
| `CommentsRepository`      | Comments      |
| `NotificationsRepository` | Notifications |
| `CurrenciesRepository`    | Currencies    |
| `CategoriesRepository`    | Categories    |

### 3.4. Utils (`src/utils/`)

#### `retry.ts`

- Exponential backoff with jitter
- `Retry-After` header support for 429
- Configurable (`maxRetries`, `baseDelayMs`, `maxDelayMs`)

#### `cache.ts`

- In-memory TTL cache
- Request deduplication for identical in-flight requests
- Token-specific cache keys (hashed fingerprint)
- Targeted invalidation on write operations
- TTL overrides for static endpoints (currencies, categories)

### 3.5. Public API (`src/index.ts`)

- `Splitwise` class as main entry point
- `SplitwiseOptions` interface for configuration
- Re-exports of all error classes, loggers, config types, and generated types

## 4. Development Workflow

### 4.1. Type Generation

```bash
npm run typegen
```

Runs `@hey-api/openapi-ts` with the config from `openapi-ts.config.ts`.

### 4.2. Build

```bash
npm run build
```

`tsup` builds in three formats:

- ESM (`dist/index.js`)
- CJS (`dist/index.cjs`)
- Type declarations (`dist/index.d.ts`, `dist/index.d.cts`)

### 4.3. Tests

```bash
npm test
```

Native `node:test` runner with `tsx` for TypeScript execution and `c8` for coverage.

### 4.4. Code Quality

- **Linting**: ESLint (`npm run check:lint`)
- **Formatting**: Prettier (`npm run check:format`)
- **Type check**: TypeScript (`npm run check:type`)
- **Pre-commit hooks**: Husky + lint-staged

### 4.5. Releases

[semantic-release](https://semantic-release.gitbook.io/) with Conventional Commits.

## 5. Dependencies

- **Runtime**: none (native `fetch` only)
- **Dev**: TypeScript, tsup, @hey-api/openapi-ts, tsx, c8, ESLint, Prettier, Husky, semantic-release
